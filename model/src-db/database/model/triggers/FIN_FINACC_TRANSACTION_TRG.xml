<?xml version="1.0"?>
  <database name="TRIGGER FIN_FINACC_TRANSACTION_TRG">
    <trigger name="FIN_FINACC_TRANSACTION_TRG" table="FIN_FINACC_TRANSACTION" fires="after" insert="true" update="true" delete="false" foreach="row">
      <body><![CDATA[

/************************************************************************
* The contents of this file are subject to the Openbravo  Public  License
* Version  1.0  (the  "License"),  being   the  Mozilla   Public  License
* Version 1.1  with a permitted attribution clause; you may not  use this
* file except in compliance with the License. You  may  obtain  a copy of
* the License at http://www.openbravo.com/legal/license.html
* Software distributed under the License  is  distributed  on  an "AS IS"
* basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
* License for the specific  language  governing  rights  and  limitations
* under the License.
* The Original Code is Openbravo ERP.
* The Initial Developer of the Original Code is Openbravo SLU
* All portions are Copyright (C) 2010-2011 Openbravo SLU
* All Rights Reserved.
* Contributor(s):  ______________________________________.
*************************************************************************/

v_Count NUMBER:=0;
  
BEGIN
   
  IF AD_isTriggerEnabled()='N' THEN RETURN;
  END IF;
  
  IF (UPDATING) THEN
    IF(:OLD.FOREIGN_CURRENCY_ID <> :NEW.FOREIGN_CURRENCY_ID 
    OR :OLD.FOREIGN_CONVERT_RATE <> :NEW.FOREIGN_CONVERT_RATE 
    OR :OLD.FOREIGN_AMOUNT <> :NEW.FOREIGN_AMOUNT) THEN
        IF(:NEW.FOREIGN_CURRENCY_ID IS NULL) THEN
          DELETE FROM C_CONVERSION_RATE_DOCUMENT WHERE APRM_FINACC_TRANSACTION_V_ID = :NEW.FIN_FINACC_TRANSACTION_ID;
        ELSE
  	  SELECT COUNT(*) INTO v_Count
  	  FROM C_CONVERSION_RATE_DOCUMENT
	  WHERE C_CURRENCY_ID = :NEW.FOREIGN_CURRENCY_ID
	  AND C_CURRENCY_ID_TO = :NEW.C_CURRENCY_ID
	  AND APRM_FINACC_TRANSACTION_V_ID = :NEW.FIN_FINACC_TRANSACTION_ID;

	  IF(V_Count = 0) THEN
	    INSERT INTO C_CONVERSION_RATE_DOCUMENT(
	        C_CONVERSION_RATE_DOCUMENT_ID, AD_CLIENT_ID, AD_ORG_ID, ISACTIVE, 
	        CREATED, CREATEDBY, UPDATED, UPDATEDBY, C_CURRENCY_ID, C_CURRENCY_ID_TO, 
	        C_INVOICE_ID, FIN_PAYMENT_ID, APRM_FINACC_TRANSACTION_V_ID, RATE, 
	        FOREIGN_AMOUNT)
	    VALUES (get_uuid(), :NEW.AD_CLIENT_ID, :NEW.AD_ORG_ID, :NEW.ISACTIVE, 
	        now(), :NEW.UPDATEDBY, now(), :NEW.UPDATEDBY, :NEW.FOREIGN_CURRENCY_ID, :NEW.C_CURRENCY_ID, 
	        NULL, NULL, :new.FIN_FINACC_TRANSACTION_ID, :NEW.FOREIGN_CONVERT_RATE, 
	        :NEW.FOREIGN_AMOUNT);
	  ELSE
	    UPDATE C_CONVERSION_RATE_DOCUMENT SET RATE = :NEW.FOREIGN_CONVERT_RATE, FOREIGN_AMOUNT = :NEW.FOREIGN_AMOUNT
	    WHERE C_CURRENCY_ID = :NEW.C_CURRENCY_ID
	    AND C_CURRENCY_ID_TO = :NEW.FOREIGN_CURRENCY_ID
	    AND APRM_FINACC_TRANSACTION_V_ID = :NEW.FIN_FINACC_TRANSACTION_ID;
	  END IF;
	END IF;
    END IF;
  END IF;
  IF(INSERTING) THEN
   IF(:NEW.FOREIGN_CONVERT_RATE <> 1) THEN
	INSERT INTO c_conversion_rate_document(
	    c_conversion_rate_document_id, ad_client_id, ad_org_id, isactive, 
	    created, createdby, updated, updatedby, c_currency_id, c_currency_id_to, 
	    c_invoice_id, fin_payment_id, aprm_finacc_transaction_v_id, rate, 
	    foreign_amount)
	VALUES (get_uuid(), :NEW.AD_CLIENT_ID, :NEW.AD_ORG_ID, :NEW.ISACTIVE, 
	    now(), :NEW.UPDATEDBY, now(), :NEW.UPDATEDBY, :NEW.FOREIGN_CURRENCY_ID, :NEW.C_CURRENCY_ID, 
	    NULL, NULL, :NEW.FIN_FINACC_TRANSACTION_ID, :NEW.FOREIGN_CONVERT_RATE, 
	    :NEW.FOREIGN_AMOUNT);
   END IF;
  END IF;
  END FIN_FINACC_TRANSACTION_TRG
]]></body>
    </trigger>
  </database>
